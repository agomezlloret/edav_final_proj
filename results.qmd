# Results

```{r}
#| message: FALSE
library(tidyr)
library(ggplot2)
library(dplyr)

data <- read.csv("NYC Marathon Results, 2024 - Marathon Runner Results.csv")

data <- data |>
  mutate(across(where(is.character), ~ na_if(., "-"))) |>
  mutate(across(where(is.character), ~ ifelse(. == "", NA, .)))

data <- data |>
  mutate(across(where(is.integer), ~ na_if(., -1)))

# Drop IAAF Column
marathon_data <- data[,-9]

#colSums(is.na(marathon_data))

marathon_data_clean <- marathon_data |>
  filter(!(is.na(countryCode) & age == 0 & is.na(gender) & firstName == "Anonymous"))
```


```{r}
write.csv(marathon_data_clean, "marathon_data_clean.csv", row.names = FALSE)
```

## Can I check your I.D.?
```{r}

ggplot(marathon_data_clean, aes(x = age)) +
  geom_histogram(binwidth = 5, bins = 30, boundary=0, fill = "skyblue", color = "black", alpha = 0.7) +
  labs(title = "Age Distribution of Marathon Participants",
       x = "Age",
       y = "Participant Count") +
  scale_x_continuous(breaks = seq(0, 95, by = 5)) +
  theme_minimal()
```
Observations:
The distribution of participant ages is right-skewed with participants as old as 88. Most of the runners fall between 25 and 40 with a majority being between 25 and 30 years old. Median age is 43.6 years.  

## Young Women Leading the Pack for the Future
```{r}
gender_clean <- marathon_data_clean |>
  filter(gender %in% c("M", "W"))

gender_clean <- gender_clean |>
  mutate(age_group = case_when(
    age < 18 ~ "17 and under",
    age >= 18 & age <= 29 ~ "18-29",
    age >= 30 & age <= 39 ~ "30-39",
    age >= 40 & age <= 49 ~ "40-49",
    age >= 50 & age <= 59 ~ "50-59",
    age >= 60 ~ "60+",
    TRUE ~ "Unknown"
  ))

gender_age_percentages <- gender_clean |>
  group_by(age_group, gender) |>
  summarise(count = n(), .groups = 'drop') |>
  group_by(age_group) |>
  mutate(percentage = (count / sum(count)) * 100)

ggplot(gender_age_percentages, aes(x = percentage, y = age_group, fill = gender)) +
  geom_bar(stat = "identity", position = "stack", width = 0.7) +
  labs(title = "Gender Participation by Age Group",
       x = "Percentage of Participants (%)",
       y = "Age Group") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
Observations:
In the youngest age group of 18-29, women make up a majority of participants which is somewhat surprising and inspiring! Men take the majority in the other age brackets but maybe we'll see this change as those younger women continue their run journey's into later ages!

## Spaghett out of Italy's Way!
```{r}
marathon_data_filter_us <- marathon_data_clean |>
  filter(countryCode != "USA") |>
  group_by(countryCode) |>
  summarise(participant_count = n()) |>
  arrange(desc(participant_count)) |>
  top_n(10, participant_count)

ggplot(marathon_data_filter_us, aes(x= reorder(countryCode, -participant_count), y = participant_count)) +
  geom_bar(stat = "identity", fill = "purple") +
  geom_text(aes(label = participant_count), vjust = -0.3, size = 3) +
  labs(x="Country", y= "Participant Count", title = " Participants by Country (Excluding USA)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
Observation: There are participants from 136 countries, covering all continents. Excluding the US since it's the host country, we can see that a majority of runners come from Europe and the Americas with Italy topping the list with 2,345 runners! Do these countries produce winners with the fastest times?


## Speed Kings of Ethoipia
```{r}
#| message: FALSE

library(lubridate)

# Convert 'overallTime' to seconds for calculations
marathon_data_clean <- marathon_data_clean |>
  filter(!is.na(overallTime)) |>
  mutate(overallTime = hms(overallTime),   # Parse to 'Period' object
         overallTimeSec = as.numeric(overallTime),
         countryCode = if_else(countryCode == "Sai", "SAI", countryCode))  # Convert to seconds

# Calculate average finish time by country (in seconds), filter for top 20
country_avg_time <- marathon_data_clean |>
  group_by(countryCode) |>
  arrange(desc(overallTimeSec)) |>
  summarise(avg_time_sec = mean(overallTimeSec, na.rm = TRUE)) |>
  arrange(avg_time_sec) |>
  head(10) |>
  mutate(avg_time_hours = avg_time_sec / 3600)

# Plot average finish times in hours
ggplot(country_avg_time, aes(x = avg_time_hours, y = reorder(countryCode, avg_time_hours))) +
  geom_point(size = 4, color = "steelblue") +  
  geom_segment(aes(xend = 1, yend = countryCode), color = "gray") +  
  geom_text(aes(label= paste(round(avg_time_hours,2),"hrs")), vjust = .5, hjust = -0.1, color = 'darkblue') +
  labs(title = "Fastest Countries by Average Finish Time",
       x = "Average Finish Time (hours)",
       y = "Country") +
  scale_x_continuous(breaks = seq(1, max(country_avg_time$avg_time_hours), by = 0.5),
                     limits = c(1, max(country_avg_time$avg_time_hours))) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 8))  

```
Observations:
We calculated the average finish time per country and plotted the 10 fastest here. It's interesting that the countries with the most participants aren't in the list of top 10 fastest countries - this could suggest that runners in the more represented countries complete marathons as recreational or amateur athletes whereas runners from Ethiopia potentially take the sport more serious.


```{r}
#| message: FALSE

gender_clean <- gender_clean |>
  filter(!is.na(overallTime)) |>
  mutate(overallTime = hms(overallTime),   # Parse to 'Period' object
         overallTimeSec = as.numeric(overallTime))

gender_age_avg_time <- gender_clean |>
  group_by(gender, age_group) |>
  summarise(avg_time_sec = mean(overallTimeSec, na.rm = TRUE)) |>
  mutate(avg_time_hours = avg_time_sec / 3600)

ggplot(gender_age_avg_time, aes(x = age_group, y = avg_time_hours, color = gender, group = gender)) +
  geom_point(size = 4) +  # Plot points
  geom_line() +  # Connect points with lines
  geom_text(aes(label = round(avg_time_hours, 2)), vjust = -0.5, color = 'black') +  # Add labels for average times
  labs(title = "Fastest Age Group by Gender",
       x = "Age Group",
       y = "Average Finish Time (hours)",
       color = "Gender") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
Observations:

## The Age Groups that Leave Everyone in the Dust
```{r}
#| warning: FALSE

gender_clean <- gender_clean |>
  mutate(overallTimeSec = as.numeric(hms(overallTime))) |>
  mutate(avg_time_hours = overallTimeSec / 3600)

ggplot(gender_clean, aes(x = interaction(age_group, gender), y = avg_time_hours, fill = gender)) +
  geom_boxplot() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Finish Times by Age Group and Gender",
       x = "Age Group and Gender",
       y = "Finish Time (hours)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  stat_summary(fun = "median",
               geom = "text",
               aes(label = round(..y.., 2)),
               color = "black",
               hjust = 0.4,
               vjust = -0.5)
```
Observations:
(feel like we should change this to minutes or hours)


## Waves of Speed: How Age Shapes the Run Time Landscape
```{r}
#| message: FALSE

library(ggridges)

gender_clean <- gender_clean |>
  mutate(overallTimeSec = as.numeric(hms(overallTime)),
         avg_time_hours = overallTimeSec / 3600)

# Ridgeline density plot for finish times by age group
ggplot(gender_clean, aes(x = avg_time_hours, y = age_group)) +
  geom_density_ridges(fill = "yellow", alpha = 0.6) +   # Ridges for density plot
  scale_x_continuous(labels = scales::comma) +  # Format x-axis with commas
  labs(title = "Distribution of Finish Times by Age Group",
       x = "Finish Time (hours)",
       y = "Age Group") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 8),
        axis.text.x = element_text(size = 10))
```
Observation: There's a slight shift in median finish times as we progress through the age groups but a peak remains present around 3.5 hours across all age groups, some just have sharper peaks. The ridges get wider as the runners get older indicating a larger spread of finish times in those groups. Most of the ridges are right-skewed showing that most participants across the different age groups finish faster than they do slower.  

## More Races, Faster Paces?
```{r}
#| message: FALSE

gender_clean <- gender_clean |>
  mutate(overallTimeSec = as.numeric(hms(overallTime)),
         avg_time_hours = overallTimeSec / 3600)

ggplot(gender_clean, aes(x = racesCount, y = avg_time_hours)) +
  geom_point(alpha = 0.3, size=0.5, color = "steelblue") +  
  geom_smooth(method = "lm", color = "red", se = FALSE) +   # Regression line
  facet_wrap(~ age_group, scales = "free") +
  labs(title = "Correlation between Race Count and Finish Time",
       x = "Number of Races Completed",
       y = "Finish Time (hours)") +
  theme_minimal()
```
Observations: Interestingly, by plotting the regression line we can see that there really isn't a correlation between races completed and finish time until the older age groups. Runners 50 years of age and older show a positive correlation between number of races completed and their finish times for the 2024 NYC marathon.

This is good news since Sara has literally 0 races under her belt and Andrea has...1? We both still have a fighting chance!


Question 8:
```{r}

marathon_data_clean <- marathon_data_clean %>%
  mutate(age_group = case_when(
    age >= 18 & age <= 29 ~ "18-29",
    age >= 30 & age <= 39 ~ "30-39",
    age >= 40 & age <= 49 ~ "40-49",
    age >= 50 & age <= 59 ~ "50-59",
    age >= 60 ~ "60+",
    TRUE ~ "Other"
  ))

marathon_data_clean <- marathon_data_clean %>%
  mutate(overallTimeHours = overallTimeSec %/% 3600,  
         overallTimeMinutes = (overallTimeSec %% 3600) %/% 60)  

marathon_data_clean <- marathon_data_clean %>%
  mutate(overallTimeHM = paste(overallTimeHours, sprintf("%02d", overallTimeMinutes), sep = ":"))

age_group_18_29 <- marathon_data_clean %>%
  filter(age_group == "18-29")

ggplot(age_group_18_29, aes(x = overallTimeSec)) +
  geom_density(fill = "lightpink", color = "red", alpha = 0.6) +
  scale_x_continuous(
    labels = function(x) {
      # Convert seconds into hours:minutes format
      hours <- x %/% 3600
      minutes <- (x %% 3600) %/% 60
      seconds <- x %% 60
      paste0(hours, "h ", minutes, "m")
    }
  ) +
  labs(title = "Density of Overall Time (Hours:Minutes) for Age Group 18-29",
       x = "Overall Time (Hours:Minutes)",
       y = "Density") +
  theme_minimal()


```
Observations:
